# FANTASY-25 — Refine Draft System Integration & Backend Support

> **Goal:** Address backend schema gaps and API ambiguities identified during the implementation of the Draft Room UI (Story-14), ensuring seamless data flow between frontend and backend, enabling full functionality (like commissioner controls), and clarifying the API contract for fetching draft state.
>
> **Context:** The frontend implementation of the Draft Room UI (Story-14) highlighted the need for specific backend data (`commissioner_id` in league details) and revealed an ambiguity in how the frontend should fetch the initial draft state (using `league_id` vs. `draft_id`). This story focuses on making the necessary backend adjustments and aligning the frontend implementation accordingly.

---

## 1. Identified Issues & Requirements

1.  **Commissioner Controls:** The frontend's `CommissionerControls.tsx` component needs to know the `commissioner_id` for the league to determine if the current user has permission to pause/resume the draft. The `LeagueOut` schema currently lacks this field.
2.  **Initial Draft State Fetch:** The frontend (`DraftPage.tsx`) needs to fetch the current state of a draft using the `league_id` available from the URL. However, the primary backend endpoint is defined as `GET /api/v1/draft/{draft_id}/state`. A clear mechanism is needed for the frontend to get the draft state using the `league_id`.
3.  **API Contract Clarity:** Ensure the data structures returned by backend endpoints (`LeagueOut`, `DraftStateResponse`) contain all necessary identifiers (`league_id`, `draft_id`, `commissioner_id`) required by the frontend components.

---

## 2. Sub‑Tasks

| Key       | Title                                                                       | Description & Deliverables                                                                                                                                                                                                                                                                                        | Acceptance Criteria                                                                                                                                                                                                                               |
| :-------- | :-------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **25-A**  | **Enhance `LeagueOut` Schema**                                              | Modify `app/api/schemas.py`: Add `commissioner_id: Optional[int]` to the `LeagueOut` Pydantic schema. Adjust the endpoint(s) returning `LeagueOut` (e.g., `GET /api/v1/leagues`, potentially a future `GET /api/v1/leagues/{league_id}`) to populate this field from the `League` model.                               | `LeagueOut` schema includes `commissioner_id`. API endpoints returning `LeagueOut` now include this field. Relevant backend tests updated/added.                                                                                                |
| **25-B**  | **Create League Draft State Endpoint**                                      | Implement a *new* backend endpoint: `GET /api/v1/leagues/{league_id}/draft/state`. This endpoint should: <br/> 1. Find the `DraftState` associated with the given `league_id`. <br/> 2. If found, return the full draft state using the existing `DraftStateResponse` schema (which includes the `draft_id` as `id`). <br/> 3. Handle cases where no draft exists for the league (e.g., 404 Not Found). Add this endpoint to an appropriate router (e.g., `app/api/draft.py`). | New endpoint `GET /api/v1/leagues/{league_id}/draft/state` exists. Returns `DraftStateResponse` (200 OK) if draft exists. Returns 404 if league or draft not found. Endpoint is documented in OpenAPI. Backend tests cover success and failure cases. |
| **25-C**  | **Update Frontend Initial Fetch**                                           | Modify `frontend/src/pages/DraftPage.tsx`: Change the initial draft state fetch to use the new `GET /api/v1/leagues/{league_id}/draft/state` endpoint instead of assuming `GET /api/v1/draft/{leagueId}/state`. Ensure the `draft_id` (returned as `id` in the response) is stored and used for subsequent API calls (`/pick`, `/pause`, `/resume`). | `DraftPage.tsx` successfully fetches initial draft state using the new endpoint. Subsequent actions (pick, pause, resume) use the correct `draft_id` obtained from the initial state response.                                                            |
| **25-D**  | **Update Frontend Commissioner Check**                                      | Modify `frontend/src/pages/DraftPage.tsx` or `frontend/src/components/draft/CommissionerControls.tsx`: Ensure it fetches league details (including the new `commissioner_id` from `LeagueOut`) and correctly compares it with the logged-in user's ID (`useAuth().user.id`) to determine if commissioner controls should be shown. | Commissioner controls are correctly shown/hidden based on the fetched `commissioner_id` and the logged-in user's ID.                                                                                                                            |
| **25-E**  | **Refine Draft Type Definitions**                                           | Review and update `frontend/src/types/draft.ts` and `frontend/src/types/League.ts` to accurately reflect the final data structures being passed between frontend and backend, including the added `commissioner_id` and ensuring `draft_id` (`id`) is present in `DraftStateResponse`. | TypeScript types accurately represent the API contract. `tsc` passes without errors.                                                                                                                                                              |
| **25-F**  | **Documentation Update**                                                    | Update relevant documentation (`docs/Architecture.md`, `docs/Story-9.md`, `docs/Story-14.md`) to reflect the new endpoint and the clarified API interactions for fetching draft state.                                                                                                     | Documentation accurately describes the `/leagues/{league_id}/draft/state` endpoint and the data flow.                                                                                                                                           |
| **25-G**  | **Testing (Backend & Frontend)**                                            | Add/update backend tests for the `LeagueOut` change and the new `/leagues/{league_id}/draft/state` endpoint. Manually verify or add basic frontend tests (if time permits) to ensure the `DraftPage` loads and commissioner controls appear correctly based on the changes.         | All backend tests related to the changes pass. Manual verification confirms the draft page loads initial state correctly and commissioner controls logic works.                                                                                     |

---

## 3. Considerations

*   **Performance:** Fetching full league details just for the `commissioner_id` might be slightly less efficient if the draft state could somehow include it. However, fetching league details once per draft page load is likely acceptable for MVP.
*   **API Consistency:** While adding a new endpoint resolves the immediate issue, consider if other parts of the API could benefit from allowing lookups via `league_id` where currently only a specific resource ID (like `draft_id`) is used. Keep API design consistent.
*   **Error Handling:** Ensure the frontend gracefully handles the case where the new `/leagues/{league_id}/draft/state` endpoint returns a 404 (e.g., draft hasn't started yet).

---