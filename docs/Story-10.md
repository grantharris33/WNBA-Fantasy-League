# FANTASY‑10 — Roster Management (Add/Drop Free Agents & Set Starters)

> **Parent story:** Roster Management
>
> **Goal:** Allow users to manage their fantasy team rosters throughout the season. This includes picking up players from the free-agent pool, dropping players from their roster, and setting their weekly starting lineup. All these actions are subject to a weekly move limit and positional rules for starters. Trades are out of scope for MVP.

---

## Table of Contents

1. Context & Business Rules
2. Sub‑tasks
3. Open Questions

---

## 1. Context & Business Rules

Effective roster management is key to a season-long fantasy league. This story enables core interactions after the initial draft.

| Rule                                | Detail                                                                                                                                                                                                                            |
| :---------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **RosterSlot Model Update**         | The `RosterSlot` model in `app/models/__init__.py` must be updated to include an `is_starter: bool` field (defaulting to `False` for new adds). This distinguishes starting players from bench players. An Alembic migration is required. |
| **Definition of "Roster Move"**     | A "Roster Move" encompasses: Changing a player's status from bench to starter.        |
| **Weekly Move Cap**                 | Max **3 Roster Moves** per fantasy team per ISO week (Monday–Sunday UTC).                                                                                                                               |
| **Fantasy Team Roster Size**        | Assume a fixed total roster size of 10 players per fantasy team (e.g., 5 starters, 5 bench). This needs to be configurable or clearly defined.                                                                                         |
| **Positional Legality of Starters** | When a user sets their starting lineup, the 5 designated starters must satisfy: **≥2 Guards (G)** AND **≥1 Forward (F) or Forward/Center (F-C)**. The remaining starter spots can be any position.                               |
| **Free Agents**                     | Players not currently in any team's `RosterSlot` for the active league are considered free agents.                                                                                                                                  |
| **Waivers**                         | None for MVP (free agent pickups are first-come, first-served).                                                                                                                                                                   |
| **Effective Time of Moves**         | Roster changes (add, drop, start, bench) apply immediately in the database. For fantasy point scoring, these changes are effective immediately.                      |
| **Transaction Logging**             | Every Roster Move must create a `transaction_log` entry detailing the action (e.g., "ADD PlayerX", "DROP PlayerY", "START PlayerZ", "BENCH PlayerA"), linked to the user and team.                                                   |
| **Team-Specific Move Counter**      | Each fantasy team will have a counter (e.g., a field on the `Team` model or a separate table) `moves_this_week`, which is incremented for each Roster Move. This counter is reset weekly.                                             |

---

## 2. Sub‑Tasks

| Key                             | Title                                                                                                   | Description & Deliverables                                                                                                                                                                                                                                                                                          | Acceptance Criteria                                                                                                                                                                                                                                                                                                                           |
| :------------------------------ | :------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **10-A: Update `RosterSlot` Model** | Add `is_starter: bool` to `RosterSlot`.                                                                 | Modify `app/models/RosterSlot.py`. Generate and apply an Alembic migration: `poetry run alembic revision --autogenerate -m "add is_starter to roster_slot"` then `poetry run alembic upgrade head`.                                                                                                                 | `RosterSlot` table has `is_starter` column. Existing slots might need a default.                                                                                                                                                                                                                                                            |
| **10-B: Implement Move Counter**  | Add `moves_this_week: int` to `Team` model (default 0).                                                 | Modify `app/models/Team.py`. Generate and apply Alembic migration. This counter will be incremented by transaction-committing services.                                                                                                                                                                                | `Team` table has `moves_this_week` column.                                                                                                                                                                                                                                                                                                  |
| **10-C: List Free Agents**        | `GET /api/v1/leagues/{league_id}/free-agents`                                                             | Endpoint returns players from `Player` table not currently in any `RosterSlot` for the given `league_id`. Response should be paginated and potentially sortable/filterable (e.g., by position, fantasy points per game - future). Schema: `Pagination[PlayerOut]`.                                              | 200 OK returns a list of `PlayerOut` objects. Returns empty list if no free agents.                                                                                                                                                                                                                                                         |
| **10-D: Add Free Agent**          | `POST /api/v1/teams/{team_id}/roster/add` <br/> Body: `{ "player_id": int, "set_as_starter": bool }`     | Validates: <br/> 1. Team `moves_this_week < weekly_move_cap`. <br/> 2. Player is a free agent. <br/> 3. Team roster size is not exceeded. <br/> If valid: Creates a new `RosterSlot` for the team and player with `is_starter` set from body. Increments `moves_this_week`. Creates `transaction_log` entry.      | 400/409 on validation failure (e.g., "Move limit reached", "Player not free agent", "Roster full"). 201 Created with updated team roster (`TeamOut` schema) on success. `moves_this_week` incremented. `transaction_log` entry created.                                                                                        |
| **10-E: Drop Player**             | `POST /api/v1/teams/{team_id}/roster/drop` <br/> Body: `{ "player_id": int }`                             | Validates: <br/> 1. Team `moves_this_week < weekly_move_cap`. <br/> 2. Player is on the specified team's roster. <br/> If valid: Deletes the `RosterSlot` for the player. Increments `moves_this_week`. Creates `transaction_log` entry.                                                                           | 400/409 on validation failure (e.g., "Move limit reached", "Player not on roster"). 200 OK with updated team roster (`TeamOut` schema) on success. `moves_this_week` incremented. `transaction_log` entry created.                                                                                                             |
| **10-F: Set Starting Lineup**     | `PUT /api/v1/teams/{team_id}/roster/starters` <br/> Body: `{ "starter_player_ids": List[int] }`           | Validates: <br/> 1. Team `moves_this_week < weekly_move_cap` *for each change in starter status*. <br/> 2. All `starter_player_ids` are on the team's roster. <br/> 3. The list contains the correct number of starters (e.g., 5). <br/> 4. The proposed starters meet positional legality rules. <br/> If valid: Updates `is_starter` for all players on the team's roster (sets to `True` for those in list, `False` for others). Increments `moves_this_week` for each player whose `is_starter` status changed. Creates `transaction_log` entries for each change. | 400/409 on validation failure. 200 OK with updated team roster (`TeamOut` schema) on success. `moves_this_week` incremented appropriately. `transaction_log` entries created for each status change.                                                                                                                                    |
| **10-G: Weekly Reset Job for Moves** | APScheduler job `reset_weekly_moves()`                                                                  | Runs every Monday at a defined UTC time (e.g., 05:00 UTC). Sets `moves_this_week = 0` for all teams in all leagues.                                                                                                                                                                                               | Job is scheduled and runs. After execution, `moves_this_week` is 0 for all teams. Test with `freezegun`.                                                                                                                                                                                                                                      |
| **10-H: Change-Log Integration**  | Ensure `ChangeLogMiddleware` (Story-8) captures these new actions.                                        | `transaction_log` entries should clearly describe the type of move (ADD, DROP, SET_STARTER, SET_BENCH) and the player involved.                                                                                                                                                                 | `transaction_log` table contains accurate records for add, drop, and starter/bench changes, viewable via the admin log endpoint.                                                                                                                                                                                                              |
| **10-I: End-to-End Tests**        | Pytest scenarios covering add, drop, and set starters.                                                  | Tests include: <br/> - Making valid moves. <br/> - Hitting the weekly move cap. <br/> - Violating positional legality for starters. <br/> - Verifying the weekly reset of the move counter.                                                                                                            | All backend tests pass in CI.                                                                                                                                                                                                                                                                                                                 |