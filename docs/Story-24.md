Okay, here's a new story document for "User Team Creation and League Association".

---
Filename: `docs/Story-24.md`
---
# FANTASY‑24 — User Team Creation and League Association

> **Goal:** Allow authenticated users to create a fantasy team, associate it with an existing league, and manage basic team details through backend API endpoints.

---

## 1. Context & Business Rules

To participate in the fantasy league, users must be able to create their own teams and join them to available leagues. This story focuses on the backend capabilities for these actions.

| Rule                                      | Detail                                                                                                                                                                                             |
| :---------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Authentication**                        | All team creation and management actions require an authenticated user.                                                                                                                              |
| **Team Creation**                         | A new team is always created and immediately associated with a specific, existing league. The creator automatically becomes the owner of the team.                                               |
| **League Existence**                      | A league must exist (identified by `league_id`) before a team can be created for it.                                                                                                               |
| **Team Ownership**                        | Only the owner of a team can modify its details.                                                                                                                                                   |
| **Team Name Uniqueness**                  | Team names must be unique within a given league. This is enforced by the database constraint `uq_team_league_name` on the `Team` model.                                                            |
| **One Team Per User Per League (MVP Rule)** | For the MVP, a user will be restricted to owning only one team per league. This simplifies initial league management.                                                                               |
| **Transaction Logging**                   | All successful team creation and update operations must be recorded in the `transaction_log` table, linked to the acting user.                                                                  |
| **Team Roster & Points**                  | Endpoints returning team information (`TeamOut`) should also provide current roster and season points, consistent with the existing `/api/v1/teams/{team_id}` detail endpoint.                    |

---

## 2. Sub‑Tasks

| Key                       | Title                                                                                                   | Description & Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                         | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                        |
| :------------------------ | :------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **24-A: Define Pydantic Schemas** | Create `TeamCreate` and `TeamUpdate` schemas. Review `TeamOut`.                                       | In `app/api/schemas.py`: <br/> - `TeamCreate(BaseModel)`: `name: str`. <br/> - `TeamUpdate(BaseModel)`: `name: Optional[str] = None`. <br/> - `TeamOut` (existing): Ensure it can be consistently populated by new endpoints. `league_id` and `owner_id` will be non-null for teams managed by these endpoints.                                                                                                                           | Schemas are defined in `app/api/schemas.py`. `mypy` passes.                                                                                                                                                                                                                                                                                                                                                                                  |
| **24-B: Implement `TeamService`** | Create `app/services/team.py` with business logic for team management.                                | `TeamService` methods: <br/> - `create_team_in_league(db: Session, name: str, league_id: int, owner_id: int) -> Team`: Creates team, checks league existence, enforces one team per user per league rule, and unique team name in league. <br/> - `get_team_by_id(db: Session, team_id: int) -> Optional[Team]`. <br/> - `get_teams_by_owner_id(db: Session, owner_id: int) -> List[Team]`. <br/> - `get_teams_by_league_id(db: Session, league_id: int) -> List[Team]`. <br/> - `update_team_details(db: Session, team_id: int, owner_id: int, data: TeamUpdate) -> Optional[Team]`: Updates team, checks ownership, enforces unique name if changed. | `TeamService` created with all methods. Logic correctly handles validations (league exists, ownership, uniqueness, one team per user per league). `TransactionLog` entries are created by the service methods upon successful CUD operations. |
| **24-C: Create Team Endpoint**    | `POST /api/v1/leagues/{league_id}/teams`                                                                | Authenticated endpoint. Uses `TeamService.create_team_in_league`. Path `league_id` and `TeamCreate` body. Returns `TeamOut` (201 Created). Handles errors (e.g., league not found, team name taken, user already has team in league) with 400/404/409.                                                                                                                                                                                           | Endpoint works as specified. Correct HTTP status codes. `TeamOut` response matches `team_detail` structure. `transaction_log` entry created.                                                                                                                                                                                                     |
| **24-D: Get User's Teams Endpoint** | `GET /api/v1/users/me/teams`                                                                            | Authenticated endpoint. Uses `TeamService.get_teams_by_owner_id` with current user's ID. Returns `List[TeamOut]`. Each `TeamOut` should be fully populated (roster, points).                                                                                                                                                                                                                                                            | Endpoint returns 200 OK with a list of `TeamOut` for the authenticated user. Empty list if no teams.                                                                                                                                                                                                                                                |
| **24-E: Get League's Teams Endpoint**| `GET /api/v1/leagues/{league_id}/teams`                                                               | Publicly accessible endpoint. Uses `TeamService.get_teams_by_league_id`. Returns `List[TeamOut]`. Each `TeamOut` fully populated.                                                                                                                                                                                                                                                                                                                   | Endpoint returns 200 OK with a list of `TeamOut` for the specified league. 404 if league not found.                                                                                                                                                                                                                                                 |
| **24-F: Update Team Endpoint**    | `PUT /api/v1/teams/{team_id}`                                                                           | Authenticated endpoint. Uses `TeamService.update_team_details`. Path `team_id` and `TeamUpdate` body. Returns `TeamOut` (200 OK). Handles errors (team not found, not owner, name taken) with 400/403/404/409.                                                                                                                                                                                                                               | Endpoint works as specified. Only team owner can update. `TeamOut` response matches `team_detail` structure. `transaction_log` entry created if changes occur.                                                                                                                                                                                |
| **24-G: Helper for `TeamOut` Population** | Create or refactor a utility function. | To consistently populate `TeamOut` (including `roster` and `season_points`) from a `Team` ORM object. This can be based on the logic in `app.api.endpoints_v1.team_detail`. This helper will be used by all endpoints returning `TeamOut` or `List[TeamOut]`. | A reusable function exists and is used by relevant endpoints to ensure consistent `TeamOut` responses. |
| **24-H: Backend Tests**           | Write unit and integration tests.                                                                       | Unit tests for all `TeamService` methods, covering success and failure paths (validations). Integration tests for all new API endpoints using `TestClient`, covering auth, request/response schemas, and status codes.                                                                                                                                                                                                             | All backend tests pass in CI. Test coverage for new service and endpoint logic is high.                                                                                                                                                                                                                                                              |

---

## 3. Notes & Considerations

*   **`TeamOut` Population**: For endpoints returning `List[TeamOut]`, populating full roster and season points for each team might be performance-intensive for large leagues or many teams. For MVP, this is acceptable. Future optimization could involve a `TeamSummaryOut` schema for lists.
*   **Database Schema for `Team`**: The `Team` model currently has `league_id` and `owner_id` as nullable. While this story's logic will always populate them, the underlying DB schema allows nulls. This is acceptable for now.
*   **Error Codes**:
    *   400 Bad Request: Invalid input (e.g., name too long, validation error from service).
    *   401 Unauthorized: Missing or invalid authentication.
    *   403 Forbidden: User is authenticated but not authorized for the action (e.g., trying to update another user's team).
    *   404 Not Found: League or Team not found.
    *   409 Conflict: Resource conflict (e.g., team name already exists in league, user already has a team in the league).
*   **Deleting Teams/Leaving Leagues**: Out of scope for this MVP story to keep complexity manageable.